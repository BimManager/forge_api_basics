<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport"
          content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=no" />
    <meta charset="utf-8">
    
    <link rel="stylesheet"
          href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css"
          type="text/css">
    
    <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>

    <style>
      body {
          margin: 0;
      }
      #forgeViewer {
          width: 100%;
          height: 100%;
          margin: 0;
          background-color: #F0F8FF;
      }
    </style>
  </head>
  <body>
    <div id="forgeViewer"></div>
  </body>
  
  <script>
    var viewer;
    // INITIALIZATION
    let options = {
      env: 'AutodeskProduction2',
      api: 'streamingV2',
      getAccessToken: function(onTokenReady) {
        fetch('http://localhost:3000/api/forge/auth/token')
          .then(function(response) {
            response.json()
              .then(function(token) {
                onTokenReady(token.access_token, token.expires_in);
              });
          })
          .catch(function(error) {
            console.error(error);
          });
      }
    };

    Autodesk.Viewing.Initializer(options, function() {
      let htmlDiv = document.getElementById('forgeViewer');
      viewer = new Autodesk.Viewing.GuiViewer3D(htmlDiv);
      let status = viewer.start();
      if (status > 0) {
        console.error('Failed to initialise the Viewer: WebGL not supported.');
      } else {
        console.info('Initialization has completed successfully.');
      }
    });


    // LOADING A MODEL
    const modelUrn = 'urn:dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6Zm9obGlvX3Jldml0X21vZGVscy9yYWNfYmFzaWNfc2FtcGxlX3Byb2plY3QucnZ0';
    Autodesk.Viewing.Document.load(
      modelUrn,onDocumentLoadSuccess, onDocumentLoadFailure);

    function onDocumentLoadSuccess(doc) {
      let defaultModel = doc.getRoot().getDefaultGeometry();
      viewer.loadExtension('Autodesk.DocumentBrowser');
      viewer.loadDocumentNode(doc, defaultModel);
    }

    function onDocumentLoadFailure() {
      console.error('Failure loading a model...');
    }

    function findAllInstancesByTypeUniqueId(propertyDb, uniqueId) {
      function userFunction(pdb) {
        const externalIdDbId = pdb.getExternalIdMapping();
        const dbId = externalIdDbId['705e25a1-127e-4d76-b5f5-4e766ef073a3-000f1bef'];
        console.log(dbId);
        const dbIds = [];
        if (dbId) {
          const item  = pdb.getObjectProperties(dbId);
          item.properties.forEach(function(property) {
            if (11 === property.type) dbIds.push(property.displayValue);
          });
        }
        return dbIds;
      }
      let promise = propertyDb.executeUserFunction(userFunction);
      promise.then(function(dbIds) {
        console.log(dbIds);
        viewer.isolate(dbIds);
        viewer.fitToView(dbIds);
      })
        .catch(function(error) {
          console.error(error);
        });
    }
  </script>
</html>
